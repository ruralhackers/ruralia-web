---
import Base from './Base.astro';
import { getCollection } from 'astro:content';

interface Props {
  title: string;
  description: string;
  date: string;
  author: string;
  keywords?: string[];
  ogImage?: string;
}

const { title, description, date, author, keywords, ogImage } = Astro.props;

const slug = Astro.url.pathname.replace(/\/$/, '').split('/').pop();
const canonicalURL = `https://ruralia.gal/blog/${slug}/`;

const schema = [
  {
    '@context': 'https://schema.org',
    '@type': 'Article',
    headline: title,
    description,
    datePublished: date,
    image: ogImage ? (ogImage.startsWith('http') ? ogImage : `https://ruralia.gal${ogImage}`) : 'https://ruralia.gal/images/ruralia-1.jpg',
    inLanguage: 'es',
    mainEntityOfPage: {
      '@type': 'WebPage',
      '@id': canonicalURL,
    },
    author: { '@type': 'Person', name: author },
    publisher: {
      '@type': 'Organization',
      name: 'Rural IA',
      url: 'https://ruralia.gal',
    },
    ...(keywords && keywords.length > 0 ? { keywords: keywords.join(', ') } : {}),
  },
  {
    '@context': 'https://schema.org',
    '@type': 'BreadcrumbList',
    itemListElement: [
      { '@type': 'ListItem', position: 1, name: 'Inicio', item: 'https://ruralia.gal/' },
      { '@type': 'ListItem', position: 2, name: 'Blog', item: 'https://ruralia.gal/blog/' },
      { '@type': 'ListItem', position: 3, name: title, item: canonicalURL },
    ],
  },
];

const formattedDate = new Date(date).toLocaleDateString('es-ES', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// Related posts: prefer posts sharing keywords, fallback to most recent
const allPosts = await getCollection('blog');
const otherPosts = allPosts.filter((p) => p.id !== slug);

let relatedPosts;
if (keywords && keywords.length > 0) {
  const scored = otherPosts.map((p) => {
    const postKw = p.data.keywords || [];
    const shared = keywords.filter((kw) => postKw.includes(kw)).length;
    return { post: p, score: shared };
  });
  scored.sort((a, b) => b.score - a.score || new Date(b.post.data.date).getTime() - new Date(a.post.data.date).getTime());
  relatedPosts = scored.slice(0, 3).map((s) => s.post);
} else {
  relatedPosts = otherPosts
    .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
    .slice(0, 3);
}

const shareTitle = encodeURIComponent(title);
const shareURL = encodeURIComponent(canonicalURL);
---

<Base title={`${title} | Rural IA`} description={description} ogImage={ogImage} ogType="article" schema={schema} keywords={keywords} date={date} author={author}>
  <article class="section">
    <div class="article-inner">
      <header class="article-header">
        <p class="article-meta">{formattedDate} &middot; {author}</p>
        <h1>{title}</h1>
        <p class="article-desc">{description}</p>
      </header>
      <div class="article-body">
        <slot />
      </div>
      <footer class="article-footer">
        <hr />
        <div class="share-links">
          <span class="share-label">Compartir:</span>
          <a href={`https://twitter.com/intent/tweet?text=${shareTitle}&url=${shareURL}`} target="_blank" rel="noopener noreferrer" aria-label="Compartir en Twitter/X">X</a>
          <a href={`https://www.linkedin.com/sharing/share-offsite/?url=${shareURL}`} target="_blank" rel="noopener noreferrer" aria-label="Compartir en LinkedIn">LinkedIn</a>
          <button class="copy-url-btn" data-url={canonicalURL} aria-label="Copiar enlace">Copiar enlace</button>
        </div>
        <p>¿Te ha gustado este artículo? <a href="/retiro-ia-galicia/">Conoce nuestro retiro de IA en Galicia</a> — 4 días de formación práctica, todo incluido.</p>
      </footer>
    </div>
  </article>

  {relatedPosts.length > 0 && (
    <section class="section related-section">
      <div class="article-inner">
        <h2 class="related-heading">Artículos relacionados</h2>
        <ul class="related-list">
          {relatedPosts.map((p) => (
            <li>
              <a href={`/blog/${p.id}/`}>{p.data.title}</a>
              <span class="related-date">{new Date(p.data.date).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' })}</span>
            </li>
          ))}
        </ul>
      </div>
    </section>
  )}
</Base>

<script>
  document.querySelectorAll('.copy-url-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      const url = (btn as HTMLElement).dataset.url;
      if (url) {
        navigator.clipboard.writeText(url).then(() => {
          const original = btn.textContent;
          btn.textContent = 'Copiado';
          setTimeout(() => { btn.textContent = original; }, 2000);
        });
      }
    });
  });
</script>

<style>
  .article-inner {
    max-width: 720px;
    margin: 0 auto;
  }
  .article-header {
    margin-bottom: 2rem;
  }
  .article-meta {
    color: #888;
    font-size: 0.9rem;
    margin: 0 0 0.5rem;
  }
  .article-header h1 {
    font-size: 2.25rem;
    margin: 0 0 0.75rem;
  }
  .article-desc {
    font-size: 1.15rem;
    color: #555;
    margin: 0;
  }
  .article-body {
    font-size: 1.05rem;
    line-height: 1.75;
  }
  .article-body :global(h2) {
    font-size: 1.5rem;
    margin-top: 2.5rem;
  }
  .article-body :global(h3) {
    font-size: 1.2rem;
    margin-top: 2rem;
  }
  .article-body :global(pre) {
    background: #f5f5f5;
    padding: 1rem;
    border-radius: 8px;
    overflow-x: auto;
  }
  .article-body :global(img) {
    border-radius: 8px;
    margin: 1.5rem 0;
  }
  .article-footer {
    margin-top: 3rem;
    color: #555;
  }
  .article-footer hr {
    border: none;
    border-top: 1px solid #e5e7eb;
    margin-bottom: 1.5rem;
  }

  /* Share links */
  .share-links {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }
  .share-label {
    font-size: 0.9rem;
    font-weight: 600;
    color: #666;
  }
  .share-links a {
    font-size: 0.9rem;
    font-weight: 500;
    text-decoration: none;
    padding: 0.35rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    color: var(--color-text);
    transition: border-color 0.15s ease, background 0.15s ease;
  }
  .share-links a:hover {
    border-color: var(--verde-musgo);
    background: var(--blanco-niebla);
    color: var(--verde-bosque);
  }
  .copy-url-btn {
    font-size: 0.9rem;
    font-weight: 500;
    font-family: var(--font-body);
    padding: 0.35rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: transparent;
    color: var(--color-text);
    cursor: pointer;
    transition: border-color 0.15s ease, background 0.15s ease;
  }
  .copy-url-btn:hover {
    border-color: var(--verde-musgo);
    background: var(--blanco-niebla);
    color: var(--verde-bosque);
  }

  /* Related posts */
  .related-section {
    padding-top: 0;
  }
  .related-heading {
    font-size: 1.3rem;
    margin: 0 0 1rem;
  }
  .related-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .related-list li {
    padding: 0.75rem 0;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 1rem;
  }
  .related-list a {
    font-weight: 500;
    text-decoration: none;
    font-size: 1rem;
  }
  .related-list a:hover {
    text-decoration: underline;
  }
  .related-date {
    font-size: 0.85rem;
    color: #888;
    white-space: nowrap;
  }
</style>
